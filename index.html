<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Space Battle</title>
<style>
  html,body{
    margin:0;padding:0;overflow:hidden;background:black;
    width:100%;height:100%;
  }
  canvas{
    display:block;
    position:absolute;
    top:10%; /* top black bar */
    height:75%;
    left:0;right:0;margin:auto;
    background:url("assets/background.png") center/cover no-repeat;
  }
</style>
</head>
<body>
<canvas id="game"></canvas>
<script>
const canvas=document.getElementById("game");
const ctx=canvas.getContext("2d");
let W=window.innerWidth,H=window.innerHeight*0.75;
canvas.width=W;canvas.height=H;

window.addEventListener("resize",()=>{
  W=window.innerWidth;H=window.innerHeight*0.75;
  canvas.width=W;canvas.height=H;
});

const img=(src)=>{const i=new Image();i.src=src;return i;}
const playerImg=img("assets/player.png");
const enemyImg=img("assets/enemy.png");
const bossImg=img("assets/boss.png");
const bulletImg=img("assets/bullet_green.png");
const enemyBulletImg=img("assets/bullet_red.png");
const heartImg=img("assets/heart.png");
const powerImgs={
  shield:img("assets/power_shield.png"),
  double:img("assets/power_double_fire.png"),
  life:img("assets/power_extra_life.png")
};

let player={x:W/2-25,y:H-100,w:50,h:50,life:3,hits:0,score:0,power:null};
let bullets=[],enemyBullets=[],enemies=[],bosses=[],powers=[];
let lastPlayerShot=0,lastEnemyShot=0,lastPowerSpawn=0,lastBossSpawnScore=0;

function drawPlayer(){
  ctx.drawImage(playerImg,player.x,player.y,player.w,player.h);
}

function spawnEnemy(){
  const x=Math.random()*(W-50);
  enemies.push({x,y:-50,w:50,h:50,hp:1});
}

function spawnPower(){
  const types=["shield","double","life"];
  const type=types[Math.floor(Math.random()*types.length)];
  const x=Math.random()*(W-60);
  powers.push({x,y:-50,w:40,h:40,type});
}

function spawnBoss(){
  for(let i=0;i<2;i++){
    const x=Math.random()*(W-100);
    bosses.push({x,y:-100,w:100,h:100,hp:10,fireTimer:0});
  }
}

function drawBullets(list,imgSrc){
  list.forEach(b=>ctx.drawImage(imgSrc,b.x,b.y,b.w,b.h));
}

function update(){
  ctx.clearRect(0,0,W,H);
  drawPlayer();

  // Player bullets
  bullets.forEach(b=>b.y-=8);
  bullets=bullets.filter(b=>b.y>-20);
  drawBullets(bullets,bulletImg);

  // Enemy bullets
  enemyBullets.forEach(b=>b.y+=5);
  enemyBullets=enemyBullets.filter(b=>b.y<H);
  drawBullets(enemyBullets,enemyBulletImg);

  // Enemies
  enemies.forEach(e=>{e.y+=2;ctx.drawImage(enemyImg,e.x,e.y,e.w,e.h);});
  enemies=enemies.filter(e=>e.y<H);

  // Bosses
  bosses.forEach(b=>{
    b.y+=1.5;
    ctx.drawImage(bossImg,b.x,b.y,b.w,b.h);
    b.fireTimer+=16;
    if(b.fireTimer>500){ // 3-bullet burst
      for(let i=-1;i<=1;i++)
        enemyBullets.push({x:b.x+b.w/2+i*15,y:b.y+b.h,w:10,h:20});
      b.fireTimer=0;
    }
  });
  bosses=bosses.filter(b=>b.y<H);

  // Powers
  powers.forEach(p=>{p.y+=2;ctx.drawImage(powerImgs[p.type],p.x,p.y,p.w,p.h);});
  powers=powers.filter(p=>p.y<H);

  handleCollisions();
  drawHUD();
  requestAnimationFrame(update);
}

function handleCollisions(){
  // Bullet–Enemy
  bullets.forEach(b=>{
    enemies.forEach((e,ei)=>{
      if(intersect(b,e)){enemies.splice(ei,1);b.y=-999;player.score+=10;}
    });
    bosses.forEach((bo,bi)=>{
      if(intersect(b,bo)){
        bo.hp--;b.y=-999;
        if(bo.hp<=0){bosses.splice(bi,1);player.score+=100;}
      }
    });
  });

  // Enemy bullets – Player
  enemyBullets.forEach((eb,ebi)=>{
    if(intersect(eb,player)){
      enemyBullets.splice(ebi,1);
      player.hits++;
      if(player.hits>=3){player.life--;player.hits=0;}
      if(player.life<=0){alert("Game Over! Score: "+player.score);location.reload();}
    }
  });

  // Power pickup
  powers.forEach((p,pi)=>{
    if(intersect(p,player)){
      showPopup(p.type);
      if(p.type==="shield") player.power="shield";
      if(p.type==="double") player.power="double";
      if(p.type==="life") player.life++;
      powers.splice(pi,1);
    }
  });

  // Boss spawn condition
  if(player.score>=1000 && (player.score-lastBossSpawnScore)>=500){
    spawnBoss();
    lastBossSpawnScore=player.score;
  }
}

function showPopup(type){
  const txt=(type==="shield"?"Shield!":type==="double"?"2X Fire!":"Life +1");
  ctx.font="20px Arial";ctx.fillStyle="white";
  ctx.fillText(txt,player.x,player.y-10);
}

function drawHUD(){
  for(let i=0;i<player.life;i++)
    ctx.drawImage(heartImg,10+i*30,10,25,25);
  ctx.fillStyle="white";ctx.font="16px Arial";
  ctx.fillText("Score: "+player.score,10,50);
}

function intersect(a,b){
  return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y;
}

// Firing
setInterval(()=>{
  bullets.push({x:player.x+player.w/2-5,y:player.y,w:10,h:20});
  if(player.power==="double")
    bullets.push({x:player.x+player.w/2+10,y:player.y,w:10,h:20});
},100);

// Enemy firing
setInterval(()=>{
  enemies.forEach(e=>{
    enemyBullets.push({x:e.x+e.w/2-5,y:e.y+e.h,w:10,h:20});
  });
},500);

// Enemy spawn
setInterval(()=>spawnEnemy(),1500);

// Power spawn
setInterval(()=>{
  if(powers.length<1) spawnPower();
},2000);

// Touch/Swipe & Drag Controls
let startX=null;
canvas.addEventListener("touchstart",(e)=>{startX=e.touches[0].clientX;});
canvas.addEventListener("touchmove",(e)=>{
  if(startX===null)return;
  const dx=e.touches[0].clientX-startX;
  player.x+=dx*0.2;
  player.x=Math.max(0,Math.min(W-player.w,player.x));
  startX=e.touches[0].clientX;
});
canvas.addEventListener("touchend",()=>{startX=null;});

update();
</script>
</body>
</html>
